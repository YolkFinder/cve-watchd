#!/bin/bash

# Set up directories and copy files
if [ ! -d "/etc/cve-watchd" ]; then
  sudo mkdir /etc/cve-watchd
fi

if [ ! -d "/var/lib/cve-watchd/" ]; then
  sudo mkdir /var/lib/cve-watchd/
fi

if [ ! -f "/usr/bin/cve-watchd" ]; then
  sudo cp cve-watchd /usr/bin/
fi

if [ ! -f "/etc/cve-watchd/rss.txt" ]; then
  sudo touch /etc/cve-watchd/rss.txt
fi

if [ ! -f "/etc/cve-watchd/monitored.txt" ]; then
  sudo touch /etc/cve-watchd/monitored.txt
fi

if [ ! -f "/etc/cve-watchd/ignore.txt" ]; then
  sudo touch /etc/cve-watchd/ignore.txt
fi

if [ ! -f "/var/lib/cve-watchd/cve_data.json" ]; then
  sudo touch /var/lib/cve-watchd/cve_data.json
fi

# Set permissions
if ! id -u watchd > /dev/null 2>&1; then
  sudo useradd -r watchd
fi

sudo chmod 755 /usr/bin/cve-watchd
sudo chown watchd:watchd /usr/bin/cve-watchd
sudo chown watchd:watchd /var/lib/cve-watchd -R
sudo chmod 644 /etc/cve-watchd/*
sudo chmod 664 /var/lib/cve-watchd/cve_data.json

# Create systemd unit file
sudo bash -c 'cat > /etc/systemd/system/cve-watchd.service << EOF
[Unit]
Description=CVE Watchdog Daemon
After=network.target

[Service]
Type=simple
Restart=always
RestartSec=5s
User=watchd
Group=watchd
ExecStart=/usr/bin/cve-watchd --config /etc/cve-watchd/config.yaml --rss /etc/cve-watchd/rss.txt --monitored /etc/cve-watchd/monitored.txt --ignore /etc/cve-watchd/ignore.txt
ExecStop=/bin/kill -TERM $MAINPID

[Install]
WantedBy=multi-user.target
EOF'

# Create config file
if [ ! -f "/etc/cve-watchd/config.json" ]; then
  sudo bash -c 'cat > /etc/cve-watchd/config.json << EOF
{
    "rssfile": "/etc/cve-watchd/rss.txt",
    "monfile": "/etc/cve-watchd/monitored.txt",
    "ignorefile": "/etc/cve-watchd/ignore.txt",
    "dbpath": "/var/lib/cve-watchd/cve_data.json"
}
EOF'
fi

# Reload systemd configuration and start service
sudo systemctl daemon-reload
sudo systemctl enable cve-watchd.service
sudo systemctl start cve-watchd.service

